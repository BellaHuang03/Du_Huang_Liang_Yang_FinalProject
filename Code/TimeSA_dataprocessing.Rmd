1.  Session Set up :
```{r, message = FALSE}
library(tidyverse)
library(lubridate)  
library(zoo)
library(trend)
library(here)
library(ggplot2)
library(Kendall)
library(dplyr)
library(readr)
library(purrr)
getwd()

mytheme <- theme_classic(base_size = 14) +
  theme(axis.text = element_text(color = "black"),
        panel.background = element_rect(fill ="white", color = NA),
        plot.background = element_rect(fill = "white", color = NA),
        plot.title = element_text(
          hjust = 0.5,         
          face = "bold"),
        legend.position = "middle")


```
2. Import the ten datasets from the time_series folder in the egrid_Data data folder. 
```{r, echo=FALSE}
library(readr)
ts2018 <- read_csv("Data/Raw/egrid_Data/time_series/ts2018.csv")
ts2019 <- read_csv("Data/Raw/egrid_Data/time_series/ts2019.csv")
ts2020 <- read_csv("Data/Raw/egrid_Data/time_series/ts2020.csv")
ts2021 <- read_csv("Data/Raw/egrid_Data/time_series/ts2021.csv")
ts2022 <- read_csv("Data/Raw/egrid_Data/time_series/ts2022.csv")
ts2023 <- read_csv("Data/Raw/egrid_Data/time_series/ts2023.csv")

```

```{r, echo=FALSE}
library(dplyr)

all_ts <- bind_rows(
  ts2018,
  ts2019,
  ts2020,
  ts2021,
  ts2022,
  ts2023,
  .id = "source_file"
)

# fill all missing value with NA
all_ts <- all_ts %>%
  mutate(across(everything(), ~ na_if(.x, "")))

# preview
dim(all_ts)
names(all_ts)
glimpse(all_ts)
```

3. Set date column as a date class.

```{r, message = FALSE}
# keep only rows where Data Year is exactly 4 digits
valid_year_rows <- grepl("^\\d{4}$", as.character(all_ts$`Data Year`))
all_ts <- all_ts[valid_year_rows, ]

#data exploration
unique(all_ts$`Plant primary coal/oil/gas/ other fossil fuel category`)
table(all_ts$`Plant primary coal/oil/gas/ other fossil fuel category`)
all_ts$`Plant primary fuel category`

top6_species <- head(sort(table(all_ts$`Plant primary coal/oil/gas/ other fossil fuel category`), decreasing = TRUE), 6)
head(top6_species)

```

For each year, check the top 6 fuel type for egrid
```{r}
library(dplyr)

top6_fuels_2018 <- ts2018 %>%
  group_by(`Plant primary coal/oil/gas/ other fossil fuel category`) %>%
  summarise(
    n_plants = n_distinct(`Plant name`),   # ensures no duplicates
    .groups = "drop"
  ) %>%
  arrange(desc(n_plants)) %>%
  slice_head(n = 6)%>%
  rename(`Plant primary fuel category` = `Plant primary coal/oil/gas/ other fossil fuel category`)

top6_fuels_2019 <- ts2019 %>%
  group_by(`Plant primary coal/oil/gas/ other fossil fuel category`) %>%
  summarise(
    n_plants = n_distinct(`Plant name`),   # ensures no duplicates
    .groups = "drop"
  ) %>%
  arrange(desc(n_plants)) %>%
  slice_head(n = 6)%>%
  rename(`Plant primary fuel category` = `Plant primary coal/oil/gas/ other fossil fuel category`)

top6_fuels_2020 <- ts2020 %>%
  group_by(`Plant primary fuel category`) %>%
  summarise(
    n_plants = n_distinct(`Plant name`),   # ensures no duplicates
    .groups = "drop"
  ) %>%
  arrange(desc(n_plants)) %>%
  slice_head(n = 6)

top6_fuels_2021 <- ts2021 %>%
  group_by(`Plant primary fuel category`) %>%
  summarise(
    n_plants = n_distinct(`Plant name`),   # ensures no duplicates
    .groups = "drop"
  ) %>%
  arrange(desc(n_plants)) %>%
  slice_head(n = 6)

top6_fuels_2022 <- ts2022 %>%
  group_by(`Plant primary fuel category`) %>%
  summarise(
    n_plants = n_distinct(`Plant name`),   # ensures no duplicates
    .groups = "drop"
  ) %>%
  arrange(desc(n_plants)) %>%
  slice_head(n = 6)

top6_fuels_2023 <- ts2023 %>%
  group_by(`Plant primary fuel category`) %>%
  summarise(
    n_plants = n_distinct(`Plant name`),   # ensures no duplicates
    .groups = "drop"
  ) %>%
  arrange(desc(n_plants)) %>%
  slice_head(n = 6)

```

Combine them into one dataset
```{r}
top6_fuels_2018 <- top6_fuels_2018 %>% mutate(year = 2018)
top6_fuels_2019 <- top6_fuels_2019 %>% mutate(year = 2019)
top6_fuels_2020 <- top6_fuels_2020 %>% mutate(year = 2020)
top6_fuels_2021 <- top6_fuels_2021 %>% mutate(year = 2021)
top6_fuels_2022 <- top6_fuels_2022 %>% mutate(year = 2022)
top6_fuels_2023 <- top6_fuels_2023 %>% mutate(year = 2023)

top6_long <- bind_rows(
  top6_fuels_2018,
  top6_fuels_2019,
  top6_fuels_2020,
  top6_fuels_2021,
  top6_fuels_2022,
  top6_fuels_2023)

library(tidyr)

top6_wide <- top6_long %>%
  pivot_wider(
    id_cols = `Plant primary fuel category`,
    names_from = year,
    values_from = n_plants)

```


4. check if there's missing data
```{r, message = FALSE}
colSums(is.na(all_ts))

all_ts$FuelUnified <- dplyr::coalesce(
  all_ts$`Plant primary fuel category`,
  all_ts$`Plant primary coal/oil/gas/ other fossil fuel category`
)

```

```{r, message = FALSE}
all_ts <- all_ts %>%
  filter(
    `Plant nameplate capacity (MW)` != "NAMEPCAP",
    `Plant annual net generation (MWh)` != "PLNGENAN",
    `Plant name` != "PNAME",
    `Data Year` != "YEAR"
  ) %>%
  select(
    -source_file,
    -`Plant primary fuel category`
  )

all_ts <- all_ts %>%
  mutate(
    cap_mw = parse_number(`Plant nameplate capacity (MW)`),
    gen_mwh = parse_number(`Plant annual net generation (MWh)`)
  )

all_ts <- all_ts %>%
  mutate(
    Data_Year_char = as.character(`Data Year`),
    Data_Year_num  = as.integer(Data_Year_char)
  )

table(all_ts$Data_Year_num, useNA = "ifany")


annual_totals <- all_ts %>%
  filter(FuelUnified %in% c("WIND", "SOLAR", "HYDRO")) %>%
  group_by(Data_Year_num, FuelUnified) %>%
  summarise(
    total_capacity_MW = sum(cap_mw, na.rm = TRUE),
    total_generation_MWh = sum(gen_mwh, na.rm = TRUE),
    n_plants = n(),
    .groups = "drop"
  )

```


5. Plot the trend for generating capacity over 2018-2023 for wind, solar, and hydro
```{R, message = FALSE}
library(ggplot2)
ggplot(annual_totals, aes(x = Data_Year_num, y = total_capacity_MW, color = FuelUnified)) +
  geom_line(linewidth = 1.3) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(
    title = "Wind, Solar, and Hydro Capacity Additions (2018–2023)",
    x = "Year",
    y = "Total Nameplate Capacity (MW)",
    color = "Technology"
  ) +
  theme_minimal(base_size = 14)

```
>Is wind  increasing or decreasing?
Is solar accelerating faster?
Which is more volatile?

```{r, message = FALSE}
wind_trend <- lm(total_capacity_MW ~ Data_Year_num,
                 data = annual_totals %>% filter(FuelUnified == "WIND"))

solar_trend <- lm(total_capacity_MW ~ Data_Year_num,
                  data = annual_totals %>% filter(FuelUnified == "SOLAR"))

summary(wind_trend)
summary(solar_trend)

```

Linear regression test
```{r}
library(dplyr)
library(broom)

# Filter to the three technologies you plotted:
techs <- c("HYDRO", "SOLAR", "WIND")

trend_lm <- annual_totals %>%
  filter(FuelUnified %in% techs) %>%
  group_by(FuelUnified) %>%
  do(tidy(lm(total_capacity_MW ~ Data_Year_num, data = .))) %>%
  filter(term == "Data_Year_num")

trend_lm

```

Mann–Kendall Non-parametric Trend Test
```{r}
library(Kendall)
library(dplyr)

techs <- c("HYDRO", "SOLAR", "WIND")

mk_results <- annual_totals %>%
  filter(FuelUnified %in% techs) %>%
  group_by(FuelUnified) %>%
  summarise(
    mk = list(MannKendall(total_capacity_MW)),
    tau = mk[[1]]$tau,
    p_value = mk[[1]]$sl
  )

mk_results

```

Time series graph:
```{r}
# Packages
library(dplyr)
library(ggplot2)
library(cowplot)   # for plot_grid

# Function to produce two-panel trend plot for a fuel type
two_panel_trend_plot <- function(tech_name,
                                 df = annual_totals,
                                 span = 0.6,
                                 save = FALSE,
                                 filename = NULL,
                                 width = 10, height = 8, dpi = 300) {
  # prepare data
  dat <- df %>%
    filter(FuelUnified == tech_name) %>%
    arrange(Data_Year_num) %>%
    mutate(
      Year = as.integer(as.character(Data_Year_num))
    )
  
  if (nrow(dat) < 3) stop("Need at least 3 years of data for: ", tech_name)
  
  # LOESS trend (use Year numeric)
  lo <- loess(total_capacity_MW ~ Year, data = dat, span = span)
  dat <- dat %>%
    mutate(
      trend_loess = predict(lo, newdata = Year),
      residual = total_capacity_MW - trend_loess
    )
  
  # Linear model on Year
  lm_fit <- lm(total_capacity_MW ~ Year, data = dat)
  lm_tidy <- broom::tidy(lm_fit)
  lm_slope_row <- lm_tidy %>% filter(term == "Year")
  slope_est <- lm_slope_row$estimate
  slope_p   <- lm_slope_row$p.value
  
  # Mann-Kendall (non-parametric monotonic trend test)
  mk <- Kendall::MannKendall(dat$total_capacity_MW)
  tau_val <- as.numeric(mk$tau)
  mk_p    <- as.numeric(mk$sl)
  
  # Top panel: raw series + LOESS + LM (dashed)
  p_top <- ggplot(dat, aes(x = Year)) +
    geom_col(aes(y = total_capacity_MW), fill = "grey90", width = 0.6) +
    geom_point(aes(y = total_capacity_MW), size = 3, color = "#2b8cbe") +
    geom_line(aes(y = total_capacity_MW), color = "#2b8cbe", size = 0.6, alpha = 0.6) +
    geom_line(aes(y = trend_loess), color = "#225ea8", size = 1.1) +
    geom_smooth(aes(y = total_capacity_MW), method = "lm", se = FALSE,
                color = "black", linetype = "dashed", linewidth = 0.8) +
    labs(
      title = paste0(toupper(tech_name), " Capacity — Raw & Trend (", min(dat$Year), "–", max(dat$Year), ")"),
      y = "Total Capacity (MW)",
      x = NULL
    ) +
    theme_minimal(base_size = 14) +
    theme(plot.title = element_text(size = 18, hjust = 0.5))
  
  # Bottom panel: residuals
  p_bot <- ggplot(dat, aes(x = Year, y = residual)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
    geom_col(fill = "#fdae61", width = 0.6) +
    labs(
      title = "Remainder (Observed − LOESS trend)",
      y = "Residual (MW)",
      x = "Year"
    ) +
    theme_minimal(base_size = 13) +
    theme(plot.title = element_text(size = 16, hjust = 0.5))
  
  # Compose combined plot (vertical)
  combined <- plot_grid(p_top, p_bot, ncol = 1, rel_heights = c(2, 1))
  
  # Add a caption with stats using cowplot::ggdraw
  caption_text <- sprintf(
    "LM slope = %0.1f MW/year (p = %0.3g) • Mann–Kendall tau = %0.3f (p = %0.3g)",
    slope_est, slope_p, tau_val, mk_p
  )
  final_plot <- ggdraw() +
    draw_plot(combined, 0, 0.05, 1, 0.95) +
    draw_label(caption_text, x = 0.5, y = 0.02, size = 10, hjust = 0.5)
  
  if (save) {
    if (is.null(filename)) filename <- paste0(tolower(tech_name), "_trend_two_panel.png")
    ggsave(filename, plot = final_plot, width = width, height = height, dpi = dpi)
    message("Saved: ", filename)
  }
  
  return(final_plot)
}

```

```{r}
two_panel_trend_plot("WIND")

```
Solar:
```{r}
two_panel_trend_plot("SOLAR")

```
Hydro
```{r}
two_panel_trend_plot("HYDRO")
```

Try 3 panel time series:
```{r}
three_panel_trend_plot <- function(tech_name,
                                   df = annual_totals,
                                   span = 0.6,
                                   save = FALSE,
                                   filename = NULL,
                                   width = 9, height = 10, dpi = 300) {

  # ---- prepare data ----
  dat <- df %>%
    filter(FuelUnified == tech_name) %>%
    arrange(Data_Year_num) %>%
    mutate(Year = as.integer(as.character(Data_Year_num)))
  if (nrow(dat) < 3) stop("Need at least 3 years of data for: ", tech_name)

  # ---- fit LOESS & residuals ----
  lo <- loess(total_capacity_MW ~ Year, data = dat, span = span)
  dat <- dat %>%
    mutate(
      trend_loess = predict(lo, newdata = Year),
      residual = total_capacity_MW - trend_loess
    )

  # ---- linear model & Mann-Kendall ----
  lm_fit <- lm(total_capacity_MW ~ Year, data = dat)
  lm_sum <- broom::tidy(lm_fit)
  slope_est <- lm_sum$estimate[lm_sum$term == "Year"]
  slope_p   <- lm_sum$p.value[lm_sum$term == "Year"]

  mk <- Kendall::MannKendall(dat$total_capacity_MW)
  tau_val <- as.numeric(mk$tau); mk_p <- as.numeric(mk$sl)

  # ---- Panel 1: Raw data ----
  p1 <- ggplot(dat, aes(x = Year)) +
    geom_col(aes(y = total_capacity_MW), fill = "grey92", width = 0.6) +
    geom_point(aes(y = total_capacity_MW), size = 3, color = "#2b8cbe") +
    geom_line(aes(y = total_capacity_MW), color = "#2b8cbe", size = 0.6, alpha = 0.7) +
    labs(title = paste(toupper(tech_name), "- Raw Total Capacity"),
         y = "Total Capacity (MW)", x = NULL) +
    theme_minimal(base_size = 13) +
    theme(plot.title = element_text(size = 16, hjust = 0.5))

  # ---- Panel 2: Trend (LOESS) ----
  p2 <- ggplot(dat, aes(x = Year)) +
    geom_line(aes(y = trend_loess), color = "#225ea8", size = 1.4) +
    geom_point(aes(y = trend_loess), color = "#225ea8", size = 2) +
    geom_smooth(aes(y = total_capacity_MW), method = "lm", se = FALSE,
                color = "black", linetype = "dashed", linewidth = 0.8) +
    labs(title = "Estimated Trend (LOESS) + Linear Fit",
         y = "Capacity (MW)", x = NULL) +
    theme_minimal(base_size = 13) +
    theme(plot.title = element_text(size = 16, hjust = 0.5))

  # ---- Panel 3: Residuals ----
  p3 <- ggplot(dat, aes(x = Year, y = residual)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
    geom_col(fill = "#fdae61", width = 0.6) +
    labs(title = "Remainder (Observed - Trend)",
         y = "Residual (MW)", x = "Year") +
    theme_minimal(base_size = 13) +
    theme(plot.title = element_text(size = 16, hjust = 0.5))

  # ---- combine and caption ----
  combined <- plot_grid(p1, p2, p3, ncol = 1, rel_heights = c(1, 1, 0.8))

  caption_text <- sprintf(
    "LM slope = %.1f MW/yr (p = %.3g) • Mann–Kendall tau = %.3f (p = %.3g)",
    slope_est, slope_p, tau_val, mk_p
  )

  final <- ggdraw() +
    draw_plot(combined, 0, 0.04, 1, 0.96) +
    draw_label(caption_text, x = 0.5, y = 0.02, size = 10, hjust = 0.5)

  if (save) {
    if (is.null(filename)) filename <- paste0(tolower(tech_name), "_three_panel.png")
    ggsave(filename, plot = final, width = width, height = height, dpi = dpi)
    message("Saved: ", filename)
  }

  return(final)
}
```

```{r}
three_panel_trend_plot("WIND")
```

```{r}
three_panel_trend_plot("SOLAR")
```

HYDRO
```{r}
three_panel_trend_plot("HYDRO")
```



6. Plot the trend for generation over 2018-2023 for wind, solar, and hydro
```{r, message = FALSE}
library(ggplot2)
ggplot(annual_totals, aes(x = Data_Year_num, y = total_generation_MWh, color = FuelUnified)) +
  geom_line(linewidth = 1.3) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(
    title = "Wind, Solar, and Hydro Generation Additions (2018–2023)",
    x = "Year",
    y = "Total Generation (MWh)",
    color = "Technology"
  ) +
  theme_minimal(base_size = 14)

```

7.
```{r}
# Graph 1
p1 <- ggplot(annual_totals, aes(x = Data_Year_num, y = total_capacity_MW, color = FuelUnified)) +
  geom_line(linewidth = 1.3) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(
    title = "Wind, Solar, and Hydro Capacity Additions (2018–2023)",
    x = "Year",
    y = "Total Nameplate Capacity (MW)",
    color = "Technology"
  ) +
  theme_minimal(base_size = 14)

# Graph 2
p2 <- ggplot(annual_totals, aes(x = Data_Year_num, y = total_generation_MWh, color = FuelUnified)) +
  geom_line(linewidth = 1.3) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(
    title = "Wind, Solar, and Hydro Generation Additions (2018–2023)",
    x = "Year",
    y = "Total Generation (MWh)",
    color = "Technology"
  ) +
  theme_minimal(base_size = 14)

cowplot::plot_grid(p1, p2, ncol = 1, align = "hv")


```

For each year, find the top 5 states for wind, solar, and hydro
```{r}
# 1. Filter to the three technologies and valid rows
techs <- c("WIND", "SOLAR", "HYDRO")

# 2. Aggregate capacity by year, technology, and state
by_state_year <- all_ts %>%
  filter(!is.na(Data_Year_num),FuelUnified %in% techs) %>%
  group_by(Data_Year_num, FuelUnified, `Plant state abbreviation`) %>%
  summarise(
    total_capacity_MW = sum(as.numeric(cap_mw), na.rm = TRUE),
    n_plants = n_distinct(`Plant name`),
    .groups = "drop"
  )

# 3. For each year & technology, pick top 5 states by capacity
top5_states_by_year <- by_state_year %>%
  group_by(Data_Year_num, FuelUnified) %>%
  slice_max(order_by = total_capacity_MW, n = 5, with_ties = FALSE) %>%
  arrange(Data_Year_num, FuelUnified, desc(total_capacity_MW)) %>%
  ungroup()

print(top5_states_by_year)

```

Change the display of the tables
```{r}
library(dplyr)
library(purrr)
library(tibble)
library(knitr)

# years and top-N
years <- 2018:2023
top_n <- 5

# helper: build wide rank table for a single fuel
build_top5_table <- function(df, fuel, years = 2018:2023, top_n = 5) {
  # df is by_state_year (Data_Year_num, FuelUnified, `Plant state abbreviation`, total_capacity_MW)
  # returns tibble with rank + columns for each year
  rows_for_years <- map(years, function(yr) {
    df %>%
      filter(FuelUnified == fuel, Data_Year_num == yr) %>%
      arrange(desc(total_capacity_MW)) %>%
      slice_head(n = top_n) %>%
      pull(`Plant state abbreviation`) %>%
      # pad to length top_n
      { if(length(.) < top_n) c(., rep(NA_character_, top_n - length(.))) else . }
  })
  # combine into data.frame: rows = ranks (1..top_n), cols = years
  mat <- do.call(cbind, rows_for_years)
  df_out <- as.data.frame(mat, stringsAsFactors = FALSE)
  colnames(df_out) <- as.character(years)
  df_out <- tibble::rownames_to_column(df_out, var = "rank")
  df_out$rank <- seq_len(top_n)
  df_out <- df_out %>% select(rank, everything())
  return(df_out)
}

# Build the three tables
wind_table  <- build_top5_table(by_state_year, "WIND",  years, top_n)
solar_table <- build_top5_table(by_state_year, "SOLAR", years, top_n)
hydro_table  <- build_top5_table(by_state_year, "HYDRO",  years, top_n)
```

```{r}
get_state_fuel_data <- function(df, state_abbrev, fuel_type) {
  df %>%
    filter(
      FuelUnified == fuel_type,
      `Plant state abbreviation` == state_abbrev,
      !is.na(Data_Year_num)
    ) %>%
    group_by(Data_Year_num) %>%
    summarise(
      total_capacity_MW    = sum(cap_mw, na.rm = TRUE),
      total_generation_MWh = sum(gen_mwh, na.rm = TRUE),
      n_plants             = n_distinct(`Plant name`),
      .groups = "drop"
    )
}

solar_CA <- get_state_fuel_data(all_ts, "CA", "SOLAR")
hydro_WA <- get_state_fuel_data(all_ts, "WA", "HYDRO")
wind_TX  <- get_state_fuel_data(all_ts, "TX", "WIND")
solar_AK <- get_state_fuel_data(all_ts, "AK", "SOLAR")

```

Subsection 3:
By state:
1. Annual Capacity Trend (MW)
```{r}
plot_capacity_trend <- function(df, fuel, state) {
  ggplot(df, aes(x = Data_Year_num, y = total_capacity_MW)) +
    geom_line(linewidth = 1.3, color = "steelblue") +
    geom_point(size = 3, color = "steelblue") +
    geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
    labs(
      title = paste(fuel, "Capacity Additions in", state, "(2018–2023)"),
      x = "Year",
      y = "Total Nameplate Capacity (MW)"
    ) +
    theme_minimal(base_size = 14)
}

```
By state:
Annual Generation Trend (MWh)
```{r}
plot_generation_trend <- function(df, fuel, state) {
  ggplot(df, aes(x = Data_Year_num, y = total_generation_MWh)) +
    geom_line(linewidth = 1.3, color = "darkorange") +
    geom_point(size = 3, color = "darkorange") +
    geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
    labs(
      title = paste(fuel, "Generation in", state, "(2018–2023)"),
      x = "Year",
      y = "Total Generation (MWh)"
    ) +
    theme_minimal(base_size = 14)
}

```
By state: Number of Plants Over Time
```{r}
plot_plant_count <- function(df, fuel, state) {
  ggplot(df, aes(x = Data_Year_num, y = n_plants)) +
    geom_line(linewidth = 1.3, color = "purple") +
    geom_point(size = 3, color = "purple") +
    geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
    labs(
      title = paste("Number of", fuel, "Plants in", state),
      x = "Year",
      y = "Number of Plants"
    ) +
    theme_minimal(base_size = 14)
}

```

a). Solar - CA
```{r}
plot_capacity_trend(solar_CA, "Solar", "CA")
plot_generation_trend(solar_CA, "Solar", "CA")
plot_plant_count(solar_CA, "Solar", "CA")
```
b). Hydro - WA
```{r}
plot_capacity_trend(hydro_WA, "Hydro", "WA")
plot_generation_trend(hydro_WA, "Hydro", "WA")
plot_plant_count(hydro_WA, "Hydro", "WA")
```

c). Wind - TX
```{r}
plot_capacity_trend(wind_TX, "Wind", "TX")
plot_generation_trend(wind_TX, "Wind", "TX")
plot_plant_count(wind_TX, "Wind", "TX")
```
Do early adopters have faster renewable expansion?
early adopters: top states for each technology
a). aggregate into a state–year–technology table
```{r}
library(tidyr) 
state_year_tech <- by_state_year %>%
  rename(State = `Plant state abbreviation`)

state_year_tech_clean <- state_year_tech %>%
  group_by(State, Data_Year_num, FuelUnified) %>%
  summarise(
    total_capacity_MW = sum(total_capacity_MW, na.rm = TRUE),
    .groups = "drop"
  )

state_year_wide <- state_year_tech_clean %>%
  pivot_wider(
    names_from = FuelUnified,
    values_from = total_capacity_MW,
    values_fill = 0,
    names_glue = "{FuelUnified}_MW"
  )

```

pull 2018 & 2023 data
```{r}
start_year <- 2018
end_year <- 2023

wide_2018_2023 <- state_year_wide %>%
  filter(Data_Year_num %in% c(start_year, end_year)) %>%
  pivot_wider(
    id_cols = State,
    names_from = Data_Year_num,
    values_from = ends_with("_MW"),
    names_glue = "{.value}_{Data_Year_num}"
  )

```
Compute growth
```{r}
growth_df <- wide_2018_2023 %>%
  mutate(
    SOLAR_abs_growth = SOLAR_MW_2023 - SOLAR_MW_2018,
    WIND_abs_growth  = WIND_MW_2023  - WIND_MW_2018,
    HYDRO_abs_growth = HYDRO_MW_2023 - HYDRO_MW_2018
  )
```

Regressions:
```{r}
lm(SOLAR_abs_growth ~ SOLAR_MW_2018, data = growth_df) %>% summary()
lm(WIND_abs_growth  ~ WIND_MW_2018,  data = growth_df) %>% summary()
lm(HYDRO_abs_growth ~ HYDRO_MW_2018, data = growth_df) %>% summary()

```
Summary table
```{r}
library(broom)
library(dplyr)

# Run regressions for each tech
lm_solar <- lm(SOLAR_abs_growth ~ SOLAR_MW_2018, data = growth_df)
lm_wind  <- lm(WIND_abs_growth  ~ WIND_MW_2018,  data = growth_df)
lm_hydro <- lm(HYDRO_abs_growth ~ HYDRO_MW_2018, data = growth_df)
#tidy 
tidy_solar <- tidy(lm_solar)
tidy_wind  <- tidy(lm_wind)
tidy_hydro <- tidy(lm_hydro)

# Helper function to extract slope row
extract_slope <- function(tidy_df, tech_name, model_obj) {
  slope_row <- tidy_df %>% filter(term != "(Intercept)")
  
  tibble(
    Technology = tech_name,
    Slope = slope_row$estimate,
    Std_Error = slope_row$std.error,
    p_value = slope_row$p.value,
    R_squared = summary(model_obj)$r.squared
  )
}

summary_table <- bind_rows(
  extract_slope(tidy_solar, "Solar", lm_solar),
  extract_slope(tidy_wind,  "Wind",  lm_wind),
  extract_slope(tidy_hydro, "Hydro", lm_hydro)
)

summary_table
```


Measure expansion rates over time
Compare the groups 

Explartory figures:
1. Histograph, for capacity during the 6 years
```{r}
e_annual_totals <- all_ts %>%
  filter(!is.na(FuelUnified)) %>%
  group_by(Data_Year_num, FuelUnified) %>%
  summarise(
    total_capacity_MW = sum(cap_mw, na.rm = TRUE),
    total_generation_MWh = sum(gen_mwh, na.rm = TRUE),
    n_plants = n(),
    .groups = "drop"
  )

library(ggplot2)
library(dplyr)
library(forcats)

# Plot
ggplot(e_annual_totals, 
       aes(x = Data_Year_num, 
           y = total_capacity_MW, 
           fill = FuelUnified)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  labs(
    title = "Total Installed Capacity by Fuel Type and Year",
    x = "Year",
    y = "Total Capacity (MW)",
    fill = "Fuel Type"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10))
  )

```
2. regenerate the graph for only renewable energy
```{r}
renewables <- c("SOLAR", "WIND", "HYDRO", "GEOTHERMAL", "BIOMASS")

renewable_totals <- e_annual_totals %>%
  filter(FuelUnified %in% c("SOLAR", "WIND", "HYDRO", "GEOTHERMAL", "BIOMASS"))

ggplot(renewable_totals,
       aes(x = Data_Year_num,
           y = total_capacity_MW,
           fill = FuelUnified)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  labs(
    title = "Total Installed Renewable Capacity by Fuel Type",
    x = "Year",
    y = "Total Renewable Capacity (MW)",
    fill = "Fuel Type"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10))
  )

```

