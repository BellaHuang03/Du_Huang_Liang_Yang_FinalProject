1.  Session Set up :
```{r, message = FALSE}
library(tidyverse)
library(lubridate)  
library(zoo)
library(trend)
library(here)
library(ggplot2)
library(Kendall)
library(dplyr)
library(readr)
library(purrr)
getwd()

mytheme <- theme_classic(base_size = 14) +
  theme(axis.text = element_text(color = "black"),
        panel.background = element_rect(fill ="white", color = NA),
        plot.background = element_rect(fill = "white", color = NA),
        plot.title = element_text(
          hjust = 0.5,         
          face = "bold"),
        legend.position = "middle")


```
2. Import the ten datasets from the time_series folder in the egrid_Data data folder. 
```{r, echo=FALSE}
library(readr)
ts2018 <- read_csv("Data/Raw/egrid_Data/time_series/ts2018.csv")
ts2019 <- read_csv("Data/Raw/egrid_Data/time_series/ts2019.csv")
ts2020 <- read_csv("Data/Raw/egrid_Data/time_series/ts2020.csv")
ts2021 <- read_csv("Data/Raw/egrid_Data/time_series/ts2021.csv")
ts2022 <- read_csv("Data/Raw/egrid_Data/time_series/ts2022.csv")
ts2023 <- read_csv("Data/Raw/egrid_Data/time_series/ts2023.csv")

```

```{r, echo=FALSE}
library(dplyr)

all_ts <- bind_rows(
  ts2018,
  ts2019,
  ts2020,
  ts2021,
  ts2022,
  ts2023,
  .id = "source_file"
)

# fill all missing value with NA
all_ts <- all_ts %>%
  mutate(across(everything(), ~ na_if(.x, "")))

# preview
dim(all_ts)
names(all_ts)
glimpse(all_ts)
```

3. Set date column as a date class.

```{r, message = FALSE}
# keep only rows where Data Year is exactly 4 digits
valid_year_rows <- grepl("^\\d{4}$", as.character(all_ts$`Data Year`))
all_ts <- all_ts[valid_year_rows, ]

#data exploration
unique(all_ts$`Plant primary coal/oil/gas/ other fossil fuel category`)
table(all_ts$`Plant primary coal/oil/gas/ other fossil fuel category`)
all_ts$`Plant primary fuel category`

top6_species <- head(sort(table(all_ts$`Plant primary coal/oil/gas/ other fossil fuel category`), decreasing = TRUE), 6)
head(top6_species)

```

For each year, check the top 6 fuel type for egrid
```{r}
library(dplyr)

top6_fuels_2018 <- ts2018 %>%
  group_by(`Plant primary coal/oil/gas/ other fossil fuel category`) %>%
  summarise(
    n_plants = n_distinct(`Plant name`),   # ensures no duplicates
    .groups = "drop"
  ) %>%
  arrange(desc(n_plants)) %>%
  slice_head(n = 6)%>%
  rename(`Plant primary fuel category` = `Plant primary coal/oil/gas/ other fossil fuel category`)

top6_fuels_2019 <- ts2019 %>%
  group_by(`Plant primary coal/oil/gas/ other fossil fuel category`) %>%
  summarise(
    n_plants = n_distinct(`Plant name`),   # ensures no duplicates
    .groups = "drop"
  ) %>%
  arrange(desc(n_plants)) %>%
  slice_head(n = 6)%>%
  rename(`Plant primary fuel category` = `Plant primary coal/oil/gas/ other fossil fuel category`)

top6_fuels_2020 <- ts2020 %>%
  group_by(`Plant primary fuel category`) %>%
  summarise(
    n_plants = n_distinct(`Plant name`),   # ensures no duplicates
    .groups = "drop"
  ) %>%
  arrange(desc(n_plants)) %>%
  slice_head(n = 6)

top6_fuels_2021 <- ts2021 %>%
  group_by(`Plant primary fuel category`) %>%
  summarise(
    n_plants = n_distinct(`Plant name`),   # ensures no duplicates
    .groups = "drop"
  ) %>%
  arrange(desc(n_plants)) %>%
  slice_head(n = 6)

top6_fuels_2022 <- ts2022 %>%
  group_by(`Plant primary fuel category`) %>%
  summarise(
    n_plants = n_distinct(`Plant name`),   # ensures no duplicates
    .groups = "drop"
  ) %>%
  arrange(desc(n_plants)) %>%
  slice_head(n = 6)

top6_fuels_2023 <- ts2023 %>%
  group_by(`Plant primary fuel category`) %>%
  summarise(
    n_plants = n_distinct(`Plant name`),   # ensures no duplicates
    .groups = "drop"
  ) %>%
  arrange(desc(n_plants)) %>%
  slice_head(n = 6)

```

Combine them into one dataset
```{r}
top6_fuels_2018 <- top6_fuels_2018 %>% mutate(year = 2018)
top6_fuels_2019 <- top6_fuels_2019 %>% mutate(year = 2019)
top6_fuels_2020 <- top6_fuels_2020 %>% mutate(year = 2020)
top6_fuels_2021 <- top6_fuels_2021 %>% mutate(year = 2021)
top6_fuels_2022 <- top6_fuels_2022 %>% mutate(year = 2022)
top6_fuels_2023 <- top6_fuels_2023 %>% mutate(year = 2023)

top6_long <- bind_rows(
  top6_fuels_2018,
  top6_fuels_2019,
  top6_fuels_2020,
  top6_fuels_2021,
  top6_fuels_2022,
  top6_fuels_2023)

library(tidyr)

top6_wide <- top6_long %>%
  pivot_wider(
    id_cols = `Plant primary fuel category`,
    names_from = year,
    values_from = n_plants)

```


4. check if there's missing data
```{r, message = FALSE}
colSums(is.na(all_ts))

all_ts$FuelUnified <- dplyr::coalesce(
  all_ts$`Plant primary fuel category`,
  all_ts$`Plant primary coal/oil/gas/ other fossil fuel category`
)

```

```{r, message = FALSE}
all_ts <- all_ts %>%
  filter(
    `Plant nameplate capacity (MW)` != "NAMEPCAP",
    `Plant annual net generation (MWh)` != "PLNGENAN",
    `Plant name` != "PNAME",
    `Data Year` != "YEAR"
  ) %>%
  select(
    -source_file,
    -`Plant primary fuel category`
  )

all_ts <- all_ts %>%
  mutate(
    cap_mw = parse_number(`Plant nameplate capacity (MW)`),
    gen_mwh = parse_number(`Plant annual net generation (MWh)`)
  )

all_ts <- all_ts %>%
  mutate(
    Data_Year_char = as.character(`Data Year`),
    Data_Year_num  = as.integer(Data_Year_char)
  )

table(all_ts$Data_Year_num, useNA = "ifany")


annual_totals <- all_ts %>%
  filter(FuelUnified %in% c("WIND", "SOLAR", "HYDRO")) %>%
  group_by(Data_Year_num, FuelUnified) %>%
  summarise(
    total_capacity_MW = sum(cap_mw, na.rm = TRUE),
    total_generation_MWh = sum(gen_mwh, na.rm = TRUE),
    n_plants = n(),
    .groups = "drop"
  )

```


5. Plot the trend for generating capacity over 2018-2023 for wind, solar, and hydro
```{R, message = FALSE}
library(ggplot2)
ggplot(annual_totals, aes(x = Data_Year_num, y = total_capacity_MW, color = FuelUnified)) +
  geom_line(linewidth = 1.3) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(
    title = "Wind, Solar, and Hydro Capacity Additions (2018–2023)",
    x = "Year",
    y = "Total Nameplate Capacity (MW)",
    color = "Technology"
  ) +
  theme_minimal(base_size = 14)

```
>Is wind  increasing or decreasing?
Is solar accelerating faster?
Which is more volatile?

```{r, message = FALSE}
wind_trend <- lm(total_capacity_MW ~ Data_Year_num,
                 data = annual_totals %>% filter(FuelUnified == "WIND"))

solar_trend <- lm(total_capacity_MW ~ Data_Year_num,
                  data = annual_totals %>% filter(FuelUnified == "SOLAR"))

summary(wind_trend)
summary(solar_trend)

```

6. Plot the trend for generation over 2018-2023 for wind, solar, and hydro
```{r, message = FALSE}
library(ggplot2)
ggplot(annual_totals, aes(x = Data_Year_num, y = total_generation_MWh, color = FuelUnified)) +
  geom_line(linewidth = 1.3) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(
    title = "Wind, Solar, and Hydro Generation Additions (2018–2023)",
    x = "Year",
    y = "Total Generation (MWh)",
    color = "Technology"
  ) +
  theme_minimal(base_size = 14)

```

7.
```{r}
# Graph 1
p1 <- ggplot(annual_totals, aes(x = Data_Year_num, y = total_capacity_MW, color = FuelUnified)) +
  geom_line(linewidth = 1.3) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(
    title = "Wind, Solar, and Hydro Capacity Additions (2018–2023)",
    x = "Year",
    y = "Total Nameplate Capacity (MW)",
    color = "Technology"
  ) +
  theme_minimal(base_size = 14)

# Graph 2
p2 <- ggplot(annual_totals, aes(x = Data_Year_num, y = total_generation_MWh, color = FuelUnified)) +
  geom_line(linewidth = 1.3) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(
    title = "Wind, Solar, and Hydro Generation Additions (2018–2023)",
    x = "Year",
    y = "Total Generation (MWh)",
    color = "Technology"
  ) +
  theme_minimal(base_size = 14)

cowplot::plot_grid(p1, p2, ncol = 1, align = "hv")


```

For each year, find the top 5 states for wind, solar, and hydro
```{r}
# 1. Filter to the three technologies and valid rows
techs <- c("WIND", "SOLAR", "HYDRO")

# 2. Aggregate capacity by year, technology, and state
by_state_year <- all_ts %>%
  filter(!is.na(Data_Year_num),FuelUnified %in% techs) %>%
  group_by(Data_Year_num, FuelUnified, `Plant state abbreviation`) %>%
  summarise(
    total_capacity_MW = sum(as.numeric(cap_mw), na.rm = TRUE),
    n_plants = n_distinct(`Plant name`),
    .groups = "drop"
  )

# 3. For each year & technology, pick top 5 states by capacity
top5_states_by_year <- by_state_year %>%
  group_by(Data_Year_num, FuelUnified) %>%
  slice_max(order_by = total_capacity_MW, n = 5, with_ties = FALSE) %>%
  arrange(Data_Year_num, FuelUnified, desc(total_capacity_MW)) %>%
  ungroup()

print(top5_states_by_year)

```

Change the display of the tables
```{r}
library(dplyr)
library(purrr)
library(tibble)
library(knitr)

# years and top-N
years <- 2018:2023
top_n <- 5

# helper: build wide rank table for a single fuel
build_top5_table <- function(df, fuel, years = 2018:2023, top_n = 5) {
  # df is by_state_year (Data_Year_num, FuelUnified, `Plant state abbreviation`, total_capacity_MW)
  # returns tibble with rank + columns for each year
  rows_for_years <- map(years, function(yr) {
    df %>%
      filter(FuelUnified == fuel, Data_Year_num == yr) %>%
      arrange(desc(total_capacity_MW)) %>%
      slice_head(n = top_n) %>%
      pull(`Plant state abbreviation`) %>%
      # pad to length top_n
      { if(length(.) < top_n) c(., rep(NA_character_, top_n - length(.))) else . }
  })
  # combine into data.frame: rows = ranks (1..top_n), cols = years
  mat <- do.call(cbind, rows_for_years)
  df_out <- as.data.frame(mat, stringsAsFactors = FALSE)
  colnames(df_out) <- as.character(years)
  df_out <- tibble::rownames_to_column(df_out, var = "rank")
  df_out$rank <- seq_len(top_n)
  df_out <- df_out %>% select(rank, everything())
  return(df_out)
}

# Build the three tables
wind_table  <- build_top5_table(by_state_year, "WIND",  years, top_n)
solar_table <- build_top5_table(by_state_year, "SOLAR", years, top_n)
hydro_table  <- build_top5_table(by_state_year, "HYDRO",  years, top_n)
```

```{r}
get_state_fuel_data <- function(df, state_abbrev, fuel_type) {
  df %>%
    filter(
      FuelUnified == fuel_type,
      `Plant state abbreviation` == state_abbrev,
      !is.na(Data_Year_num)
    ) %>%
    group_by(Data_Year_num) %>%
    summarise(
      total_capacity_MW    = sum(cap_mw, na.rm = TRUE),
      total_generation_MWh = sum(gen_mwh, na.rm = TRUE),
      n_plants             = n_distinct(`Plant name`),
      .groups = "drop"
    )
}

solar_CA <- get_state_fuel_data(all_ts, "CA", "SOLAR")
hydro_WA <- get_state_fuel_data(all_ts, "WA", "HYDRO")
wind_TX  <- get_state_fuel_data(all_ts, "TX", "WIND")
solar_AK <- get_state_fuel_data(all_ts, "AK", "SOLAR")

```
By state:
1. Annual Capacity Trend (MW)
```{r}
plot_capacity_trend <- function(df, fuel, state) {
  ggplot(df, aes(x = Data_Year_num, y = total_capacity_MW)) +
    geom_line(linewidth = 1.3, color = "steelblue") +
    geom_point(size = 3, color = "steelblue") +
    geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
    labs(
      title = paste(fuel, "Capacity Additions in", state, "(2018–2023)"),
      x = "Year",
      y = "Total Nameplate Capacity (MW)"
    ) +
    theme_minimal(base_size = 14)
}

```
By state:
Annual Generation Trend (MWh)
```{r}
plot_generation_trend <- function(df, fuel, state) {
  ggplot(df, aes(x = Data_Year_num, y = total_generation_MWh)) +
    geom_line(linewidth = 1.3, color = "darkorange") +
    geom_point(size = 3, color = "darkorange") +
    geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
    labs(
      title = paste(fuel, "Generation in", state, "(2018–2023)"),
      x = "Year",
      y = "Total Generation (MWh)"
    ) +
    theme_minimal(base_size = 14)
}

```
By state: Number of Plants Over Time
```{r}
plot_plant_count <- function(df, fuel, state) {
  ggplot(df, aes(x = Data_Year_num, y = n_plants)) +
    geom_line(linewidth = 1.3, color = "purple") +
    geom_point(size = 3, color = "purple") +
    geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
    labs(
      title = paste("Number of", fuel, "Plants in", state),
      x = "Year",
      y = "Number of Plants"
    ) +
    theme_minimal(base_size = 14)
}

```

a). Solar - CA
```{r}
plot_capacity_trend(solar_CA, "Solar", "CA")
plot_generation_trend(solar_CA, "Solar", "CA")
plot_plant_count(solar_CA, "Solar", "CA")
```
b). Hydro - WA
```{r}
plot_capacity_trend(hydro_WA, "Hydro", "WA")
plot_generation_trend(hydro_WA, "Hydro", "WA")
plot_plant_count(hydro_WA, "Hydro", "WA")
```

c). Wind - TX
```{r}
plot_capacity_trend(wind_TX, "Wind", "TX")
plot_generation_trend(wind_TX, "Wind", "TX")
plot_plant_count(wind_TX, "Wind", "TX")
```
Do early adopters have faster renewable expansion?
early adopters 

Measure expansion rates over time
Compare the groups 

Explartory figures:
1. Histograph, for capacity during the 6 years
```{r}
e_annual_totals <- all_ts %>%
  filter(!is.na(FuelUnified)) %>%
  group_by(Data_Year_num, FuelUnified) %>%
  summarise(
    total_capacity_MW = sum(cap_mw, na.rm = TRUE),
    total_generation_MWh = sum(gen_mwh, na.rm = TRUE),
    n_plants = n(),
    .groups = "drop"
  )

library(ggplot2)
library(dplyr)
library(forcats)

# Plot
ggplot(e_annual_totals, 
       aes(x = Data_Year_num, 
           y = total_capacity_MW, 
           fill = FuelUnified)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  labs(
    title = "Total Installed Capacity by Fuel Type and Year",
    x = "Year",
    y = "Total Capacity (MW)",
    fill = "Fuel Type"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10))
  )

```
2. regenerate the graph for only renewable energy
```{r}
renewables <- c("SOLAR", "WIND", "HYDRO", "GEOTHERMAL", "BIOMASS")

renewable_totals <- e_annual_totals %>%
  filter(FuelUnified %in% c("SOLAR", "WIND", "HYDRO", "GEOTHERMAL", "BIOMASS"))

ggplot(renewable_totals,
       aes(x = Data_Year_num,
           y = total_capacity_MW,
           fill = FuelUnified)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  labs(
    title = "Total Installed Renewable Capacity by Fuel Type",
    x = "Year",
    y = "Total Renewable Capacity (MW)",
    fill = "Fuel Type"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10))
  )

```

